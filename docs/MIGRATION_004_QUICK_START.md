# ğŸš€ Migration 004 å¿«é€ŸåŸ·è¡ŒæŒ‡å—

## å•é¡Œç¸½çµ

æ‚¨é‡åˆ°äº† 3 å€‹éŒ¯èª¤ï¼Œå·²å…¨éƒ¨ä¿®å¾©ï¼š
1. âœ… `column "easiness_factor" already exists` - å·²ä¿®å¾©ï¼ˆæ¢ä»¶å¼æ–°å¢ï¼‰
2. âœ… `structure of query does not match function result type` - å·²ä¿®å¾©ï¼ˆå‹åˆ¥åŒ¹é…ï¼‰
3. âœ… `type difficulty_enum does not exist` - å·²ä¿®å¾©ï¼ˆæ”¹ç”¨ TEXTï¼‰

---

## ğŸ¯ åŸ·è¡Œæ­¥é©Ÿï¼ˆ3 åˆ†é˜å®Œæˆï¼‰

### Step 1: é–‹å•Ÿ Supabase SQL Editor
1. å‰å¾€ [Supabase Dashboard](https://supabase.com/dashboard)
2. é¸æ“‡æ‚¨çš„å°ˆæ¡ˆ
3. å·¦å´é¸å–®é»æ“Š **SQL Editor**
4. é»æ“Š **New query**

### Step 2: åŸ·è¡Œä¸€éµä¿®å¾©è…³æœ¬ â­
1. é–‹å•Ÿæª”æ¡ˆï¼š`supabase/migrations/004_QUICK_FIX.sql`
2. **è¤‡è£½æ‰€æœ‰å…§å®¹**ï¼ˆ200 è¡Œï¼‰
3. **è²¼åˆ° SQL Editor**
4. é»æ“Š **Run** æŒ‰éˆ•ï¼ˆæˆ–æŒ‰ Ctrl+Enterï¼‰
5. ç­‰å¾…ç´„ 5-10 ç§’
6. çœ‹åˆ° **Success** âœ…

> ğŸ’¡ é€™å€‹è…³æœ¬æœƒè‡ªå‹•ï¼š
> - æ¸…ç†æ‰€æœ‰èˆŠç‰©ä»¶ï¼ˆè§¸ç™¼å™¨ã€å‡½æ•¸ã€ç´¢å¼•ã€æ¬„ä½ï¼‰
> - æ–°å¢ 11 å€‹ SM-2 æ¼”ç®—æ³•æ¬„ä½
> - å»ºç«‹ 3 å€‹ RPC å‡½æ•¸
> - å»ºç«‹ 3 å€‹ç´¢å¼•
> - å»ºç«‹ 1 å€‹è‡ªå‹•æ›´æ–°è§¸ç™¼å™¨
> - åˆå§‹åŒ–ç¾æœ‰éŒ¯é¡Œè³‡æ–™

### Step 3: é©—è­‰å®‰è£ï¼ˆé¸æ“‡æ€§ï¼‰

åœ¨ SQL Editor åŸ·è¡Œä»¥ä¸‹æŸ¥è©¢ï¼š

```sql
-- 1ï¸âƒ£ æª¢æŸ¥æ¬„ä½ï¼ˆæ‡‰è©²å›å‚³ 11ï¼‰
SELECT COUNT(*) AS column_count
FROM information_schema.columns 
WHERE table_name = 'questions' 
AND column_name IN (
  'easiness_factor', 'repetitions', 'interval', 
  'review_state', 'next_review_date', 'last_quality',
  'total_reviews', 'correct_reviews', 'average_quality',
  'first_reviewed_at', 'graduated_at'
);

-- 2ï¸âƒ£ æª¢æŸ¥ RPC å‡½æ•¸ï¼ˆæ‡‰è©²å›å‚³ 3ï¼‰
SELECT COUNT(*) AS function_count
FROM information_schema.routines 
WHERE routine_name IN ('get_due_questions', 'get_review_stats', 'get_review_streak');

-- 3ï¸âƒ£ æª¢æŸ¥ç´¢å¼•ï¼ˆæ‡‰è©²å›å‚³ 3ï¼‰
SELECT COUNT(*) AS index_count
FROM pg_indexes 
WHERE tablename = 'questions' 
AND indexname IN (
  'idx_questions_next_review_date',
  'idx_questions_review_state', 
  'idx_questions_user_review'
);
```

**é æœŸçµæœ**ï¼š
- column_count: **11** âœ…
- function_count: **3** âœ…
- index_count: **3** âœ…

### Step 4: æ¸¬è©¦ RPC å‡½æ•¸

å–å¾—æ‚¨çš„ User IDï¼š
1. Supabase Dashboard â†’ **Authentication** â†’ **Users**
2. è¤‡è£½æ‚¨çš„ **UUID**ï¼ˆé•·å¾—åƒï¼š`12345678-1234-1234-1234-123456789abc`ï¼‰

åŸ·è¡Œæ¸¬è©¦ï¼š
```sql
-- æ›¿æ›ç‚ºæ‚¨çš„ User ID
SELECT * FROM get_due_questions('YOUR-USER-ID-HERE'::uuid, 10);
```

**é æœŸçµæœ**ï¼š
- å¦‚æœæœ‰éŒ¯é¡Œï¼šå›å‚³éŒ¯é¡Œåˆ—è¡¨ âœ…
- å¦‚æœæ²’éŒ¯é¡Œï¼šå›å‚³ç©ºçµæœ âœ…ï¼ˆæ­£å¸¸ï¼‰
- å¦‚æœå‡ºéŒ¯ï¼šæª¢æŸ¥ User ID æ˜¯å¦æ­£ç¢º

### Step 5: æ¸¬è©¦å‰ç«¯ ğŸ‰

1. å›åˆ°æ‚¨çš„æ‡‰ç”¨ç¨‹å¼
2. **åˆ·æ–°ç€è¦½å™¨**ï¼ˆCtrl + Shift + Rï¼‰
3. **é–‹å•Ÿ DevTools Console**ï¼ˆæŒ‰ F12ï¼‰
4. é»æ“Š **ã€Œæ™ºèƒ½è¤‡ç¿’ã€** æŒ‰éˆ•

**æª¢æŸ¥ Console è¨Šæ¯**ï¼š
```
âœ… æ‡‰è©²çœ‹åˆ°ï¼š
ğŸ“š å‘¼å« get_due_questions RPC: {user_id: "...", limit: 50}
âœ… å–å¾—å¾…è¤‡ç¿’é¡Œç›®: 5

âŒ ä¸æ‡‰è©²çœ‹åˆ°ï¼š
Failed to load resource: 500
å–å¾—å¾…è¤‡ç¿’é¡Œç›®å¤±æ•—
structure of query does not match
```

---

## ğŸŠ æˆåŠŸæ¨™èªŒ

å¦‚æœæ‚¨çœ‹åˆ°ä»¥ä¸‹ä»»ä¸€æƒ…æ³ï¼Œä»£è¡¨æˆåŠŸï¼š

1. **æœ‰å¾…è¤‡ç¿’é¡Œç›®**ï¼š
   - ReviewQueue é¡¯ç¤ºé¡Œç›®åˆ—è¡¨
   - å¯ä»¥é€²è¡Œè¤‡ç¿’
   - å“è³ªè©•åˆ†æŒ‰éˆ•å¯é»æ“Š

2. **æ²’æœ‰å¾…è¤‡ç¿’é¡Œç›®**ï¼š
   - é¡¯ç¤ºã€Œä»Šæ—¥æ²’æœ‰éœ€è¦è¤‡ç¿’çš„é¡Œç›®ã€
   - åœ–ç¤ºå’Œæ–‡å­—æ­£å¸¸é¡¯ç¤º
   - æ²’æœ‰éŒ¯èª¤è¨Šæ¯

3. **Console ç„¡éŒ¯èª¤**ï¼š
   - æ²’æœ‰ç´…è‰²éŒ¯èª¤è¨Šæ¯
   - æ²’æœ‰ 500 éŒ¯èª¤
   - åªæœ‰è—è‰²/ç¶ è‰²çš„ log

---

## ğŸ†˜ ç–‘é›£æ’è§£

### å•é¡Œ 1ï¼šåŸ·è¡Œ SQL æ™‚å‡ºç¾éŒ¯èª¤

**éŒ¯èª¤è¨Šæ¯**ï¼š`syntax error at or near...`
**è§£æ±º**ï¼šç¢ºä¿è¤‡è£½äº†å®Œæ•´çš„ SQL è…³æœ¬ï¼ˆ200 è¡Œï¼‰ï¼ŒåŒ…å«é–‹é ­å’Œçµå°¾

**éŒ¯èª¤è¨Šæ¯**ï¼š`permission denied`
**è§£æ±º**ï¼šç¢ºä¿æ‚¨æ˜¯å°ˆæ¡ˆçš„ Owner æˆ–æœ‰è¶³å¤ æ¬Šé™

### å•é¡Œ 2ï¼šå‰ç«¯ä»ç„¶é¡¯ç¤ºéŒ¯èª¤

**æ­¥é©Ÿ**ï¼š
1. ç¢ºèª SQL åŸ·è¡ŒæˆåŠŸï¼ˆçœ‹åˆ° Successï¼‰
2. æ¸…é™¤ç€è¦½å™¨å¿«å–ï¼ˆCtrl + Shift + Deleteï¼‰
3. ç¡¬åˆ·æ–°é é¢ï¼ˆCtrl + Shift + Rï¼‰
4. é‡æ–°é–‹å•Ÿ DevTools Console
5. å†æ¬¡é»æ“Šã€Œæ™ºèƒ½è¤‡ç¿’ã€

### å•é¡Œ 3ï¼šRPC æ¸¬è©¦å›å‚³ç©ºçµæœ

é€™æ˜¯**æ­£å¸¸çš„**ï¼ä»£è¡¨ï¼š
- å‡½æ•¸åŸ·è¡ŒæˆåŠŸ âœ…
- ä½†ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é¡Œç›®
- åŸå› ï¼šæ‰€æœ‰é¡Œç›®çš„ `review_state` éƒ½ä¸æ˜¯ 'new'ï¼Œä¸” `next_review_date` é‚„æ²’åˆ°æœŸ

**è§£æ±º**ï¼šæ–°å¢ä¸€é“éŒ¯é¡Œï¼Œå°±æœƒå‡ºç¾åœ¨è¤‡ç¿’ä½‡åˆ—ä¸­ï¼

---

## ğŸ“š ç›¸é—œæª”æ¡ˆ

- âœ… **ä¸€éµä¿®å¾©è…³æœ¬**ï¼š`supabase/migrations/004_QUICK_FIX.sql`ï¼ˆæ¨è–¦ï¼‰
- âœ… **å®Œæ•´ Migration**ï¼š`supabase/migrations/004_add_sm2_algorithm_fields.sql`
- âœ… **æ¸…ç†è…³æœ¬**ï¼š`supabase/migrations/004_cleanup_and_reset.sql`
- âœ… **è©³ç´°æŒ‡å—**ï¼š`docs/MIGRATION_004_FIX_GUIDE.md`

---

## ğŸ¯ ä¸‹ä¸€æ­¥

Migration 004 åŸ·è¡ŒæˆåŠŸå¾Œï¼Œæ‚¨å¯ä»¥ï¼š

1. **æ¸¬è©¦è¤‡ç¿’åŠŸèƒ½**ï¼š
   - æ–°å¢éŒ¯é¡Œ
   - é»æ“Šã€Œæ™ºèƒ½è¤‡ç¿’ã€
   - è©•åˆ†ï¼ˆ1-4ï¼‰
   - è§€å¯Ÿ SM-2 æ¼”ç®—æ³•é‹ä½œ

2. **æŸ¥çœ‹çµ±è¨ˆè³‡æ–™**ï¼ˆPhase 2A-9, 2A-10ï¼‰ï¼š
   - æ¯æ—¥è¤‡ç¿’è¶¨å‹¢åœ–
   - é€£çºŒè¤‡ç¿’å¤©æ•¸è¨ˆæ•¸å™¨

3. **ç¹¼çºŒé–‹ç™¼**ï¼š
   - Phase 2B: æœå°‹èˆ‡ç¯©é¸
   - Phase 2C: åŒ¯å‡ºåŠŸèƒ½
   - Phase 2D: OCR åœ–ç‰‡è¾¨è­˜

---

**åŸ·è¡Œæ™‚é–“**ï¼š2025-10-05  
**é è¨ˆè€—æ™‚**ï¼š3-5 åˆ†é˜  
**é›£åº¦**ï¼šâ­ ç°¡å–®ï¼ˆè¤‡è£½è²¼ä¸Šå³å¯ï¼‰

æœ‰ä»»ä½•å•é¡Œï¼Œè«‹æä¾›å®Œæ•´éŒ¯èª¤è¨Šæ¯ï¼ğŸš€
